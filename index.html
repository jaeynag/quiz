<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>ìƒì‹í€´ì¦ˆ</title>
  <link rel="icon" href="data:," />
  <style>
    :root{
      --bg:#f5f6f8;
      --card:#fff;
      --text:#111;
      --muted:#6b7280;
      --line:#e6e8ee;
      --accent:#2b6cff;
      --good:#16a34a;
      --bad:#ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:"ë§‘ì€ ê³ ë”•", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display:flex;
      justify-content:center;
      padding:20px;
    }
    .app{width:min(920px, 100%);}
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    h1{margin:0; font-size:20px; letter-spacing:-.2px}
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      white-space:nowrap;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }

    .compact{ width:min(320px, 100%); margin:0 auto; }
    .label{font-size:12.5px; color:var(--muted); font-weight:1000; margin-bottom:6px}
    input{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      font-size:14px;
      outline:none;
    }
    input:focus{border-color:#cfd5e2; box-shadow:0 0 0 3px rgba(43,108,255,.10)}

    .hr{height:1px; background:var(--line); margin:12px 0}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row > *{flex:1}
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      padding:11px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:1000;
      font-size:14px;
      transition:.12s transform, .12s border;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); border-color:#cfd5e2}
    .btn:disabled{opacity:.7; cursor:not-allowed; transform:none}
    .btn.primary{background:var(--accent); border-color:var(--accent); color:#fff}
    .btn.ghost{background:#fff}
    .btn.danger{border-color:#ffd2d2; color:var(--bad); background:#fff}

    /* Mode screen */
    .userline{
      font-size:12.5px;
      color:var(--muted);
      font-weight:900;
      margin-bottom:10px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .grid3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
    @media (max-width:860px){ .grid3{grid-template-columns:1fr} }

    .modeBtn{
      width:100%;
      padding:14px 12px;
      font-size:15px;
      border-radius:16px;
    }

    .lbCard{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:#fff;
      min-height:140px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .lbHead{display:flex; align-items:center; justify-content:space-between; gap:8px}
    .lbTitle{font-weight:1000}
    .lbHint{font-size:12px; color:var(--muted); font-weight:900; white-space:nowrap}
    .lbList{margin:0; padding:0 0 0 18px; color:var(--muted)}
    .lbList li{margin:6px 0; display:flex; gap:8px; align-items:baseline}
    .lbList .who{flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .lbList .sc{font-weight:1000; color:#111; white-space:nowrap}

    /* Quiz screen */
    .quizWrap{width:min(360px, 100%); margin:0 auto;}
    .qmeta{display:flex; gap:8px; flex-wrap:wrap; justify-content:space-between; align-items:center}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:7px 10px; border-radius:999px;
      border:1px solid var(--line); background:#fff;
      font-size:12px; color:var(--muted); font-weight:900;
      white-space:nowrap;
    }
    .progress{height:9px; border-radius:999px; background:#eef1f7; overflow:hidden; border:1px solid var(--line); width:min(280px, 100%);}
    .bar{height:100%; width:0%; background:var(--accent); transition:width .2s}
    .qtext{font-size:15px; line-height:1.35; font-weight:1000; letter-spacing:-.2px; margin:10px 0 2px 0}
    .answers{display:grid; gap:10px; margin-top:10px}
    .choice{width:100%; text-align:left; padding:12px 10px}

    /* Modal */
    .modalBackdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:50;
    }
    .modalBackdrop.show{display:flex}
    .modal{
      width:min(320px, 100%);
      border-radius:18px;
      background:#fff;
      border:1px solid var(--line);
      box-shadow: 0 18px 60px rgba(0,0,0,.25);
      padding:12px;
    }
    .modalTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:8px;
    }
    .modalTitle{
      margin:0;
      font-size:18px;
      font-weight:1100;
      letter-spacing:-.2px;
    }
    .modalTitle.good{color:var(--good)}
    .modalTitle.bad{color:var(--bad)}
    .modalBody{
      color:#111;
      line-height:1.45;
      font-size:14px;
    }
    .modalBody .muted{color:var(--muted); font-size: 16px; margin-top:8px}
    .modalBtns{display:flex; gap:10px; margin-top:12px}
    .modalBtns .btn{flex:1}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:#111; color:#fff; padding:10px 12px; border-radius:999px;
      font-size: 16px; opacity:0; pointer-events:none; transition:.2s opacity;
      max-width:min(720px, calc(100% - 40px));
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      z-index:60;
    }
    .toast.show{opacity:1}
  
    /* Timer FX */
    .pill.timer{transition: .15s transform, .15s border, .15s background, .15s color;}
    .pill.timer.ok{border-color:var(--line); background:#fff; color:var(--muted);}
    .pill.timer.warn{border-color:rgba(245,158,11,.45); background:rgba(245,158,11,.10); color:#7c5a00;}
    .pill.timer.bad{border-color:rgba(239,68,68,.55); background:rgba(239,68,68,.10); color:var(--bad);}
    .pill.timer.pulse{animation:pulse .55s ease-in-out infinite;}
    @keyframes pulse{
      0%{transform:scale(1)}
      50%{transform:scale(1.04)}
      100%{transform:scale(1)}
    }
    .bar.warn{background:rgb(245,158,11);}
    .bar.bad{background:var(--bad);}

  
  .ver-badge{
    position: fixed;
    right: 10px;
    bottom: 10px;
    padding: 4px 8px;
    border-radius: 999px;
    font-size: 11px;
    line-height: 1;
    background: rgba(0,0,0,0.35);
    color: #fff;
    z-index: 9998;
    pointer-events: none;
    backdrop-filter: blur(6px);
    opacity: 0.85;
  }

  /* Sticker pop (ì—°ì†ì •ë‹µ ë³´ìƒ) */
  .sticker-pop{
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%,-50%) scale(0.2);
    opacity: 0;
    z-index: 9997;
    pointer-events: none;
    will-change: transform, opacity;
  }
  .sticker-pop.show{
    animation: stickerIn .22s cubic-bezier(.2,.9,.2,1.2) forwards,
               stickerOut .28s ease-in forwards;
    animation-delay: 0s, 0.92s; /* ì´ 1.2ì´ˆ */
  }
  .sticker-pop img{
    width: min(38vw, 190px);
    max-height: 38vh;
    display: block;
    filter:
      drop-shadow( 2px  0px 0px rgba(255,255,255,.92))
      drop-shadow(-2px  0px 0px rgba(255,255,255,.92))
      drop-shadow( 0px  2px 0px rgba(255,255,255,.92))
      drop-shadow( 0px -2px 0px rgba(255,255,255,.92))
      drop-shadow(0 10px 18px rgba(0,0,0,.28));
    border-radius: 10px;
  }
  @keyframes stickerIn{
    from{ opacity:0; transform: translate(-50%,-50%) scale(0.2) rotate(var(--rot)); }
    to  { opacity:1; transform: translate(-50%,-50%) scale(1.0) rotate(var(--rot)); }
  }
  @keyframes stickerOut{
    to{ opacity:0; transform: translate(-50%,-50%) scale(0.85) rotate(var(--rot)); }
  }
  /* Sticker board */
  .sticker-board{
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 50; /* below modal/toast, above background */
  }
  .sticker-stuck{
    position: absolute;
    will-change: transform, opacity;
    animation: stickerIn .22s cubic-bezier(.2,.9,.2,1.2) forwards;
  }
  .sticker-stuck img{
    width: min(34vw, 170px);
    max-height: 34vh;
    display: block;
    filter:
      drop-shadow( 2px  0px 0px rgba(255,255,255,.92))
      drop-shadow(-2px  0px 0px rgba(255,255,255,.92))
      drop-shadow( 0px  2px 0px rgba(255,255,255,.92))
      drop-shadow( 0px -2px 0px rgba(255,255,255,.92))
      drop-shadow( 0px 10px 18px rgba(0,0,0,.18));
    border-radius: 10px;
  }

</style>
</head>
<body>
  <div class="app">
    <header>
      <h1 id="appTitle">ìƒì‹í€´ì¦ˆ</h1>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <span class="badge">ë¬¸ì œ:<span id="qCountBadge">-</span></span>
        <span class="badge">ë­í‚¹:<span id="rankBadge">-</span></span>
</div>
    </header>

    <!-- Login -->
    <section id="screenLogin" class="card compact">
      <div class="label">ì´ë¦„</div>
      <input id="inpName" placeholder="ì˜ˆ: ì¥í•˜ì–‘" maxlength="30" autocomplete="name" />
      <div style="height:10px"></div>
      <div class="label">ì¶œì‹ í•™êµ</div>
      <input id="inpSchool" placeholder="ì˜ˆ: ê³µì£¼ê³ " maxlength="40" autocomplete="organization" />
      <div class="hr"></div>
      <div class="row" style="justify-content:flex-end;">
        <button class="btn primary" id="btnGoMode" style="flex:0 0 auto; min-width:120px;">ë‹¤ìŒ</button>
      </div>
    </section>

    <!-- Mode -->
    <section id="screenMode" class="card" style="display:none;">
      <div class="userline" id="whoLine">-</div>

      <div class="grid3">
        <div>
          <button class="btn primary modeBtn" data-mode="humanities">ë¬¸ê³¼ìƒì‹</button>
          <div style="height:10px"></div>
          <div class="lbCard">
            <div class="lbHead"><div class="lbTitle">ë¬¸ê³¼ TOP 3</div><div class="lbHint" id="lbHintH">-</div></div>
            <ol class="lbList" id="lbHumanities"></ol>
          </div>
        </div>

        <div>
          <button class="btn primary modeBtn" data-mode="science">ì´ê³¼ìƒì‹</button>
          <div style="height:10px"></div>
          <div class="lbCard">
            <div class="lbHead"><div class="lbTitle">ì´ê³¼ TOP 3</div><div class="lbHint" id="lbHintS">-</div></div>
            <ol class="lbList" id="lbScience"></ol>
          </div>
        </div>

        <div>
          <button class="btn primary modeBtn" data-mode="mixed">í†µí•©</button>
          <div style="height:10px"></div>
          <div class="lbCard">
            <div class="lbHead"><div class="lbTitle">í†µí•© TOP 3</div><div class="lbHint" id="lbHintM">-</div></div>
            <ol class="lbList" id="lbMixed"></ol>
          </div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="row">
        <button class="btn ghost" id="btnBackToLogin">ì´ë¦„/í•™êµ ë‹¤ì‹œ</button>
        <button class="btn ghost" id="btnRefreshLB">ë­í‚¹ ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </section>

    <!-- Quiz -->
    <section id="screenQuiz" class="card quizWrap" style="display:none;">
      <div class="qmeta">
        <div class="pill">ëª¨ë“œ: <strong id="modePill">-</strong></div>
        <div class="pill">ì ìˆ˜: <strong id="scorePill">0</strong></div>
        <div class="pill timer ok" id="timePillWrap">ë‚¨ì€ì‹œê°„: <strong id="timePill">5</strong>s</div>
        <div class="progress" aria-hidden="true"><div class="bar" id="progBar"></div></div>
      </div>

      <div class="qtext" id="qText">-</div>
      <div class="answers" id="answers"></div>

      <div class="hr"></div>
      <button class="btn danger" id="btnQuit">ê·¸ë§Œí•˜ê¸°</button>
    </section>
  </div>

  <!-- Sticker Board (stickers accumulate) -->
  <div id="stickerBoard" class="sticker-board" aria-hidden="true"></div>

  <!-- Sticker Pop -->
  <div id="stickerPop" class="sticker-pop" aria-hidden="true"><img id="stickerImg" alt="sticker" /></div>

  <!-- Modal -->
  <div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalTop">
        <h2 class="modalTitle" id="modalTitle">-</h2>
        <span class="badge" id="modalBadge">-</span>
      </div>
      <div class="modalBody" id="modalBody">-</div>
      <div class="modalBtns" id="modalBtns"></div>
    </div>
  </div>
  <div class="toast" id="toast"></div>

<script>
  const APP_VERSION = "2025.12.13-02";

(() => {
  const $ = (id) => document.getElementById(id);

  const CONFIG = {
    serverBase: "https://quiz-leaderboard.yangsquiz.workers.dev"
  };

  const LS = {
    name: "quiz_name",
    school: "quiz_school"
  };

  const MODE_LABEL = {
    humanities: "ë¬¸ê³¼",
    science: "ì´ê³¼",
    mixed: "í†µí•©"
  };

  const state = {
    questions: null,
    mode: null,
    pool: [],
    idx: 0,
    score: 0,
    locked: false,
    timer: null,
    remaining: 5,
    streak: 0
  };

  function toast(msg){
    const el = $("toast");
    el.textContent = msg;
    el.classList.add("show");
    clearTimeout(el._t);
    el._t = setTimeout(() => el.classList.remove("show"), 1400);
  }

  // ì—°ì†ì •ë‹µ ìŠ¤í‹°ì»¤(5ì ë§ˆë‹¤)
  // ì‚¬ì§„ì€ ë ˆí¬ì— ì´ë ‡ê²Œ ë„£ì–´ì¤˜: assets/cats/cat_01.png, cat_02.png ...
  let STICKER_IMAGES = Array.from({ length: 60 }, (_, i) =>
    `assets/cats/cat_${String(i + 1).padStart(2, "0")}.png`
  );

  
  // ìŠ¤í‹°ì»¤ ì´ë¯¸ì§€ ì„ íƒ ë°©ì‹
  // - false: 5ì ,10ì ,15ì ... ìˆœì„œëŒ€ë¡œ(cat_01, cat_02, ...)
  // - true : ë§¤ë²ˆ ëœë¤(ì¤‘ë³µ ìµœì†Œí™”: í•œ ë°”í€´ ëŒ ë•Œê¹Œì§€ ê°™ì€ ì‚¬ì§„ ì•ˆ ë‚˜ì˜´)
  const STICKER_RANDOM = true;
  let _stickerBag = [];
  let _stickerPtr = 0;

  function _shuffle(a){
    for (let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  function nextStickerSrc(streak){
    if (!STICKER_IMAGES.length) return null;

    if (!STICKER_RANDOM){
      const idx = Math.floor(streak/5) - 1;
      return STICKER_IMAGES[idx % STICKER_IMAGES.length];
    }

    if (_stickerBag.length !== STICKER_IMAGES.length){
      _stickerBag = _shuffle(Array.from({length: STICKER_IMAGES.length}, (_,i)=>i));
      _stickerPtr = 0;
    }
    if (_stickerPtr >= _stickerBag.length){
      _stickerBag = _shuffle(_stickerBag);
      _stickerPtr = 0;
    }
    const pick = _stickerBag[_stickerPtr++];
    return STICKER_IMAGES[pick];
  }
function popStickerForStreak(streak){
    if (streak < 5) return;
    if (streak % 5 !== 0) return;
    const src = nextStickerSrc(streak);
    if (!src) return;
    popSticker(src);
  }

  function popSticker(src){
    const board = $("stickerBoard");
    if (!board) return;

    // ìŠ¤í‹°ì»¤ ìš”ì†Œ ìƒì„±(ëˆ„ì )
    const el = document.createElement("div");
    el.className = "sticker-stuck";
    const img = document.createElement("img");
    img.alt = "";
    img.src = src;
    img.onerror = () => { try { el.remove(); } catch(e){} };
    el.appendChild(img);

    // ëœë¤ íšŒì „(-10~+10) + ì‚´ì§ ìŠ¤ì¼€ì¼(0.92~1.03)
    const rot = (randInt(21) - 10);
    const sc  = (92 + randInt(12)) / 100;
    el.style.transform = `translate3d(0,0,0) rotate(${rot}deg) scale(${sc})`;

    // ë°°ì¹˜: 'í€´ì¦ˆ ì¹´ë“œ ì£¼ë³€' ë§(ë„ˆë¬´ ì‚¬ì´ë“œë¡œ ì•ˆ ê°€ê²Œ)
    const avoidEl = $("screenQuiz");
    const vw = window.innerWidth;
    const vh = window.innerHeight;

    const avoid = avoidEl ? avoidEl.getBoundingClientRect() : { left: vw*0.25, top: vh*0.25, right: vw*0.75, bottom: vh*0.75 };

    const pad = 12;     // í™”ë©´ ê°€ì¥ìë¦¬ ì—¬ë°±
    const ring = 200;   // ì¹´ë“œ ì£¼ë³€ ë²”ìœ„(ì»¤ì§ˆìˆ˜ë¡ ë” ë©€ë¦¬ë„ ê°)
    const w = Math.min(vw*0.34, 170); // ì´ë¯¸ì§€ ì˜ˆìƒ í­(ëŒ€ëµ)
    const h = Math.min(vh*0.34, 170); // ëŒ€ëµ(ì •ì‚¬ê° ê°€ì •)

    // ë§ ì˜ì—­(ì¹´ë“œ ì£¼ë³€ì˜ í™•ì¥ ì‚¬ê°í˜•)
    const outer = {
      left: Math.max(pad, avoid.left - ring),
      top: Math.max(pad, avoid.top - ring),
      right: Math.min(vw - pad, avoid.right + ring),
      bottom: Math.min(vh - pad, avoid.bottom + ring)
    };

    // ì¹´ë“œ ìì²´(ê²¹ì¹¨ ê¸ˆì§€ ì˜ì—­) ì¡°ê¸ˆ ë” í‚¤ì›€
    const inner = {
      left: avoid.left - 6,
      top: avoid.top - 6,
      right: avoid.right + 6,
      bottom: avoid.bottom + 6
    };

    function intersects(a,b){
      return !(a.right < b.left || a.left > b.right || a.bottom < b.top || a.top > b.bottom);
    }


    let x = pad, y = pad;
    let ok = false;
    for (let t=0; t<40; t++){
      const rx = outer.left + Math.random() * Math.max(1, (outer.right - outer.left - w));
      const ry = outer.top  + Math.random() * Math.max(1, (outer.bottom - outer.top - h));
      const r = { left: rx, top: ry, right: rx + w, bottom: ry + h };
      // ì¹´ë“œë‘ ì•ˆ ê²¹ì¹˜ê³ (ë¬¸ì œ ê°€ë¦¬ì§€ ì•Šê¸°), ìŠ¤í‹°ì»¤ë¼ë¦¬ ê³¼ë„ ê²¹ì¹¨ë§Œ í”¼í•˜ê¸°
      if (!intersects(r, inner) ){
        x = rx; y = ry; ok = true; break;
      }
    }
    if (!ok){
      // ìµœí›„: ìœ„/ì•„ë˜ ë¼ì¸ ìª½
      x = Math.min(vw - pad - w, Math.max(pad, avoid.left + (avoid.right-avoid.left)*Math.random() - w/2));
      y = (Math.random() < 0.5) ? Math.max(pad, avoid.top - ring/1.4) : Math.min(vh - pad - h, avoid.bottom + ring/1.4);
    }

    el.style.left = `${x}px`;
    el.style.top  = `${y}px`;

    board.appendChild(el);

    // ë„ˆë¬´ ë§ì•„ì§€ë©´ ì˜¤ë˜ëœ ê²ƒë¶€í„° ì •ë¦¬(í™”ë©´ ë‚œì¥íŒ ë°©ì§€)
    const MAX_STICKERS = 40;
    while (board.children.length > MAX_STICKERS){
      board.removeChild(board.firstElementChild);
    }
  }


  function showScreen(which){
    ["screenLogin","screenMode","screenQuiz"].forEach(id => {
      $(id).style.display = (id === which ? "" : "none");
    });
    // ë©”ì¸(ë¡œê·¸ì¸/ëª¨ë“œ)ì—ì„œë§Œ ë²„ì „ ë°°ì§€ ë³´ì´ê²Œ
    const vb = $("verBadge");
  const bd = $("stickerBoard");
const tt = $("appTitle");
    if (vb) vb.style.display = (which === "screenQuiz" ? "none" : "block");
  if (bd) bd.style.display = (which === "screenQuiz" ? "block" : "none");
  if (which !== "screenQuiz") { try { clearStickerBoard(); } catch(e){} }
if (tt) {
    // í€´ì¦ˆ í™”ë©´ì—ì„œëŠ” íƒ€ì´í‹€ ìë¦¬ëŠ” ìœ ì§€í•˜ê³  ê¸€ìë§Œ ìˆ¨ê¹€(ë°°ì§€ ìœ„ì¹˜ ê³ ì •)
    tt.style.visibility = (which === "screenQuiz" ? "hidden" : "visible");
  }
  }


  function getUser(){
    return {
      name: (localStorage.getItem(LS.name) || "").trim(),
      school: (localStorage.getItem(LS.school) || "").trim()
    };
  }
  function setUser(name, school){
    localStorage.setItem(LS.name, (name || "").trim());
    localStorage.setItem(LS.school, (school || "").trim());
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  async function loadQuestions(){
    if (state.questions) return state.questions;
    const res = await fetch("./questions.json", { cache: "no-store" });
    if (!res.ok) throw new Error("questions.json ë¡œë“œ ì‹¤íŒ¨");
    const data = await res.json();
    if (!data || !Array.isArray(data.questions)) throw new Error("questions.json í˜•ì‹ ì´ìƒí•¨");

    const qs = data.questions.filter(q =>
      q && typeof q.id === "string" &&
      (q.mode === "humanities" || q.mode === "science") &&
      typeof q.q === "string" &&
      Array.isArray(q.choices) && q.choices.length === 2 &&
      (q.answer === 0 || q.answer === 1) &&
      typeof q.explain === "string"
    );

    // (ì¤‘ë³µ ë°©ì§€) ê°™ì€ ëª¨ë“œì—ì„œ ì§ˆë¬¸ í…ìŠ¤íŠ¸(q)ê°€ ì™„ì „íˆ ê°™ì€ ë¬¸ì œëŠ” 1ê°œë§Œ ë‚¨ê¹€
    const _seenQ = new Set();
    const uniq = [];
    for (const q of qs){
      const key = q.mode + "|" + String(q.q || "").trim();
      if (_seenQ.has(key)) continue;
      _seenQ.add(key);
      uniq.push(q);
    }

    state.questions = uniq;
    $("qCountBadge").textContent = String(uniq.length);
// ë²„ì „ í‘œì‹œ(ë©”íƒ€ê°€ ìˆìœ¼ë©´)
    const meta = (data && data.meta) ? data.meta : null;
    const vb = $("verBadge");
  const bd = $("stickerBoard");
const tt = $("appTitle");
    if (vb) {
      const v = meta && meta.version ? String(meta.version) : "no-meta";
      const u = meta && meta.updated ? ` ${meta.updated}` : "";
      vb.textContent = `v${APP_VERSION}`;
    }

    return qs;
  }

  function randInt(maxExclusive){
    if (maxExclusive <= 1) return 0;
    const cryptoObj = (window.crypto || window.msCrypto);
    if (cryptoObj && cryptoObj.getRandomValues){
      const buf = new Uint32Array(1);
      const limit = Math.floor(0x100000000 / maxExclusive) * maxExclusive;
      let x;
      do{
        cryptoObj.getRandomValues(buf);
        x = buf[0];
      } while (x >= limit);
      return x % maxExclusive;
    }
    return Math.floor(Math.random() * maxExclusive);
  }

  function clearStickerBoard(){
    const b = $("stickerBoard");
    if (b) b.innerHTML = "";
  }

  async function loadStickers(){
    try{
      const res = await fetch("assets/cats/stickers.json?v=" + Date.now(), { cache: "no-store" });
      if (!res.ok) throw new Error("stickers.json not found");
      const list = await res.json();
      if (!Array.isArray(list)) throw new Error("stickers.json must be an array");

      // íŒŒì¼ëª…ë§Œ ìˆìœ¼ë©´ assets/cats/ ìë™ prefix
      const mapped = list
        .map(x => String(x || "").trim())
        .filter(Boolean)
        .map(x => (x.includes("/") ? x : ("assets/cats/" + x)));

      // ì¤‘ë³µ ì œê±°(íŒŒì¼ëª… ì¤‘ë³µ ì—…ë¡œë“œ ëŒ€ë¹„)
      const seen = new Set();
      STICKER_IMAGES = mapped.filter(src => {
        if (seen.has(src)) return false;
        seen.add(src);
        return true;
      });

      // ì…”í”Œë°± ì´ˆê¸°í™”
      _stickerBag = [];
      _stickerPtr = 0;
    }catch(e){
      // stickers.jsonì´ ì—†ê±°ë‚˜ í˜•ì‹ì´ ê¹¨ì ¸ë„, ê¸°ì¡´ STICKER_IMAGES(ê¸°ë³¸ê°’)ëŠ” ìœ ì§€
      _stickerBag = [];
      _stickerPtr = 0;
      console.warn("loadStickers failed:", e);
    }
  }


  function shuffle(arr){
    for (let i = arr.length - 1; i > 0; i--) {
      const j = randInt(i + 1);
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function buildPool(mode, questions){
    if (mode === "mixed") return shuffle([...questions]);
    return shuffle(questions.filter(q => q.mode === mode));
  }

  function fillLB(listEl, arr){
    const medals = ["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"];
    listEl.innerHTML = "";
    if (!arr || arr.length === 0){
      const li = document.createElement("li");
      li.textContent = "-";
      listEl.appendChild(li);
      return;
    }
    arr.slice(0,3).forEach((e, idx) => {
      const li = document.createElement("li");

      const who = document.createElement("span");
      who.className = "who";
      const n = e?.name ?? "-";
      const s = e?.school ?? "-";
      who.textContent = `${medals[idx] || ""} ${n}(${s})`;

      const sc = document.createElement("span");
      sc.className = "sc";
      sc.textContent = `${(typeof e?.score === "number") ? e.score : 0}ì `;

      li.appendChild(who);
      li.appendChild(sc);
      listEl.appendChild(li);
    });
  }

  async function fetchLeaderboards(){
    const base = (CONFIG.serverBase || "").replace(/\/+$/,"");
    if (!base){
      $("rankBadge").textContent = "êº¼ì§";
      fillLB($("lbHumanities"), []);
      fillLB($("lbScience"), []);
      fillLB($("lbMixed"), []);
      $("lbHintH").textContent = $("lbHintS").textContent = $("lbHintM").textContent = "-";
      return;
    }

    $("rankBadge").textContent = "ì—°ê²°ì¤‘";
    $("lbHintH").textContent = $("lbHintS").textContent = $("lbHintM").textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘";

    try{
      const res = await fetch(base + "/leaderboard", { cache:"no-store" });
      if (!res.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì´ìƒ");
      const data = await res.json();
      fillLB($("lbHumanities"), data.humanities || []);
      fillLB($("lbScience"), data.science || []);
      fillLB($("lbMixed"), data.mixed || []);

      const stamp = new Date().toLocaleTimeString("ko-KR", { hour:"2-digit", minute:"2-digit" });
      $("lbHintH").textContent = $("lbHintS").textContent = $("lbHintM").textContent = stamp;
      $("rankBadge").textContent = "ì—°ê²°ë¨";
    }catch(e){
      fillLB($("lbHumanities"), []);
      fillLB($("lbScience"), []);
      fillLB($("lbMixed"), []);
      $("lbHintH").textContent = $("lbHintS").textContent = $("lbHintM").textContent = "ì‹¤íŒ¨";
      $("rankBadge").textContent = "ì‹¤íŒ¨";
    }
  }

  function stopTimer(){
    if (state.timer){
      clearInterval(state.timer);
      state.timer = null;
    }
  }

  
  function setTimerUI(rem){
    const wrap = $("timePillWrap");
    const bar = $("progBar");
    wrap.classList.remove("ok","warn","bad","pulse");
    bar.classList.remove("warn","bad");

    if (rem <= 2){
      wrap.classList.add("bad","pulse");
      bar.classList.add("bad");
    } else if (rem === 3){
      wrap.classList.add("warn");
      bar.classList.add("warn");
    } else {
      wrap.classList.add("ok");
    }

    // bar shows remaining time (100% -> 0%)
    const pct = Math.max(0, Math.min(100, (rem / 5) * 100));
    bar.style.width = pct + "%";
  }

function startTimer(){
    stopTimer();
    state.remaining = 5;
    $("timePill").textContent = "5";
    setTimerUI(5);
    state.timer = setInterval(() => {
      state.remaining -= 1;
      const rem = Math.max(0, state.remaining);
      $("timePill").textContent = String(rem);
      setTimerUI(rem);
      if (rem <= 0){
        stopTimer();
        if (!state.locked){
          gradeAnswer(null, true);
        }
      }
    }, 1000);
  }

  function renderQuestion(){
    state.locked = false;
    $("answers").innerHTML = "";
    $("scorePill").textContent = String(state.score);
const q = state.pool[state.idx];
    if (!q){
      showResultModal();
      return;
    }

    $("qText").textContent = q.q;
    $("modePill").textContent = MODE_LABEL[state.mode] || "-";

    // progress bar is used for timer (reset to full)
    $("progBar").style.width = "100%";

    q.choices.forEach((label, i) => {
      const btn = document.createElement("button");
      btn.className = "btn choice";
      btn.textContent = label;
      btn.addEventListener("click", () => gradeAnswer(i, false));
      $("answers").appendChild(btn);
    });

    startTimer();
  }

  function openModal({ title, tone, badge, bodyHtml, buttons }){
    const backdrop = $("modalBackdrop");
    $("modalTitle").textContent = title;
    $("modalTitle").className = "modalTitle " + (tone === "good" ? "good" : (tone === "bad" ? "bad" : ""));
    $("modalBadge").textContent = badge || "";
    $("modalBody").innerHTML = bodyHtml || "";

    const btns = $("modalBtns");
    btns.innerHTML = "";
    (buttons || []).forEach(b => {
      const el = document.createElement("button");
      el.className = "btn " + (b.kind || "ghost");
      el.textContent = b.text;
      el.addEventListener("click", () => {
        if (b.onClick) b.onClick();
      });
      btns.appendChild(el);
    });

    backdrop.classList.add("show");
    backdrop.setAttribute("aria-hidden", "false");
  }

  function closeModal(){
    const backdrop = $("modalBackdrop");
    backdrop.classList.remove("show");
    backdrop.setAttribute("aria-hidden", "true");
  }

  function gradeAnswer(choiceIndex, isTimeout){
    if (state.locked) return;
    state.locked = true;
    stopTimer();

    const q = state.pool[state.idx];
    const correct = (!isTimeout) && (choiceIndex === q.answer);

    if (isTimeout) state.streak = 0;

    const reason = isTimeout ? "ì‹œê°„ì´ˆê³¼" : (correct ? "ì •ë‹µ" : "ì˜¤ë‹µ");
    const explain = q.explain || "-";

    if (correct){
      state.score += 1;
      $("scorePill").textContent = String(state.score);
state.streak = (state.streak || 0) + 1;
      popStickerForStreak(state.streak);

      openModal({
        title: "ì •ë‹µ!",
        tone: "good",
        badge: `+1ì  Â· ${MODE_LABEL[state.mode]}`,
        bodyHtml: `<div>${escapeHtml(reason)}</div><div class="muted">${escapeHtml(explain)}</div>`,
        buttons: [
          { text: "ë‹¤ìŒ", kind: "primary", onClick: () => { closeModal(); state.idx += 1; renderQuestion(); } }
        ]
      });
    } else {
      state.streak = 0;
      openModal({
        title: isTimeout ? "ì‹œê°„ì´ˆê³¼!" : "ì˜¤ë‹µ!",
        tone: "bad",
        badge: `${MODE_LABEL[state.mode]} Â· ì¢…ë£Œ`,
        bodyHtml: `<div>${escapeHtml(reason)}</div><div class="muted">${escapeHtml(explain)}</div>`,
        buttons: [
          { text: "ê²°ê³¼ ë³´ê¸°", kind: "primary", onClick: () => { closeModal(); showResultModal(); } }
        ]
      });
    }
  }

  async function submitScore(){
    const base = (CONFIG.serverBase || "").replace(/\/+$/,"");
    if (!base) return { ok:false, msg:"ë­í‚¹ ì„œë²„ êº¼ì§" };

    const { name, school } = getUser();
    const body = { name, school, mode: state.mode, score: state.score };

    try{
      const res = await fetch(base + "/submit", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      if (!res.ok) throw new Error("submit failed");
      return { ok:true, msg:"ë­í‚¹ ë°˜ì˜ ì™„ë£Œ" };
    }catch(e){
      return { ok:false, msg:"ë­í‚¹ ë°˜ì˜ ì‹¤íŒ¨" };
    }
  }

  function showResultModal(){
    const { name, school } = getUser();
    const score = state.score;

    openModal({
      title: "ë!",
      tone: score > 0 ? "good" : "bad",
      badge: `${MODE_LABEL[state.mode]} Â· ${score}ì `,
      bodyHtml: `<div><strong>${escapeHtml(name)}(${escapeHtml(school)})</strong></div>
                <div class="muted" id="resStatus" style="margin-top:8px;">ë­í‚¹ ë°˜ì˜ ì¤‘...</div>`,
      buttons: [
        { text: "ëª¨ë“œ ì„ íƒìœ¼ë¡œ", kind: "primary", onClick: () => { closeModal(); showScreen("screenMode"); fetchLeaderboards(); } }
      ]
    });

    // async submit + update modal text
    submitScore().then(r => {
      const el = document.getElementById("resStatus");
      if (el) el.textContent = r.msg;
    });
  }

  function startGame(mode){
    state.mode = mode;
    state.idx = 0;
    state.score = 0;
    state.pool = [];
    state.streak = 0;

    loadQuestions().then(qs => {
      const pool = buildPool(mode, qs);
      if (pool.length < 1){
        toast("ë¬¸ì œê°€ ì—†ìŒ");
        return;
      }
      state.pool = pool;
      showScreen("screenQuiz");
      renderQuestion();
    }).catch(e => {
      console.error(e);
      toast("ë¬¸ì œ ë¡œë“œ ì‹¤íŒ¨");
    });
  }

  $("btnGoMode").addEventListener("click", async () => {
    const name = $("inpName").value.trim();
    const school = $("inpSchool").value.trim();
    if (!name || !school){
      toast("ì´ë¦„/í•™êµ ë‘˜ ë‹¤ ì ì–´");
      return;
    }
    setUser(name, school);
    $("whoLine").textContent = `${name} (${school})`;
    showScreen("screenMode");
    await loadQuestions().catch(() => {});
    loadStickers().catch(() => {});
    fetchLeaderboards();
  });

  $("btnBackToLogin").addEventListener("click", () => showScreen("screenLogin"));
  $("btnRefreshLB").addEventListener("click", () => fetchLeaderboards());

  document.querySelectorAll('button[data-mode]').forEach(btn => {
    btn.addEventListener("click", () => startGame(btn.getAttribute("data-mode")));
  });

  $("btnQuit").addEventListener("click", () => {
    
    clearStickerBoard();
// quit = show result modal (current score)
    stopTimer();
    showResultModal();
  });

  // init
  (function init(){
    $("inpName").value = localStorage.getItem(LS.name) || "";
    $("inpSchool").value = localStorage.getItem(LS.school) || "";
    $("rankBadge").textContent = (CONFIG.serverBase ? "ì—°ê²°ì¤‘" : "êº¼ì§");
    loadQuestions().catch(() => {});
    loadStickers().catch(() => {});
  })();
})();
</script>
  <div id="verBadge" class="ver-badge" aria-label="ë²„ì „" aria-hidden="true"></div>
</body>
</html>
